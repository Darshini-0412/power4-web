<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>â­Power 4 Webâ­</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../static/style.css" />
</head>
<body class="page">
  <!-- SÃ©lecteur de thÃ¨me -->
  <div class="theme-switcher">
    <button class="theme-btn" aria-label="Changer le thÃ¨me">ğŸŒ™</button>
  </div>

  <header class="header">
    <h1 class="title">â­Power 4 Webâ­</h1>
     <a href="/" class="home-btn">ğŸ  Accueil</a>
  </header>

  <main class="container">
    <!-- Section RÃ¨gles -->
    <section class="card">
      <h2>ğŸ“‹ RÃ¨gles du Jeu</h2>
      <ul class="rules">
        <li>ğŸ¯ Deux joueurs : Rouge ğŸ”´ et Jaune ğŸŸ¡</li>
        <li>ğŸ® Joue en choisissant une <strong>colonne</strong></li>
        <li>ğŸ† 4 jetons alignÃ©s = victoire (Horizontal/Vertical/Diagonale)</li>
        <li>âš–ï¸ Grille pleine sans alignement = match nul</li>
        <li>â¬‡ï¸ Utilise les flÃ¨ches pour placer tes jetons</li>
      </ul>
      
      <!-- Indicateur de tour actuel -->
      <div class="turn">
        <strong>Tour actuel :</strong>
        {{if eq .Turn "R"}}ğŸ”´ Joueur Rouge{{else}}ğŸŸ¡ Joueur Jaune{{end}}
      </div>
    </section>

    <!-- Section Plateau de jeu -->
    <section class="card" id="board">
      <h2>ğŸ® Plateau de Jeu â€” 6 x 7</h2>

      <!-- Bouton pour rÃ©initialiser la partie -->
      <form action="/reset" method="POST" class="text-center">
        <button type="submit">ğŸ”„ RÃ©initialiser la partie</button>
      </form>

      <!-- FlÃ¨ches pour jouer dans chaque colonne -->
      <div class="playbar">
        <div class="columns">
          {{range $i := seq 0 6}}
            <form class="playform" action="/play" method="POST">
              <input type="hidden" name="column" value="{{$i}}">
              <button class="col-btn" type="submit" aria-label="Jouer dans la colonne {{$i}}">
                â†“
              </button>
            </form>
          {{end}}
        </div>
      </div>

      <!-- Message de tour -->
      <p class="turn">
        <strong>Tour du joueur :</strong>
        {{if eq .Turn "R"}}ğŸ”´ Rouge{{else}}ğŸŸ¡ Jaune{{end}}
      </p>

      <!-- Message de victoire (cachÃ©, utilisÃ© pour le modal) -->
      {{if .Winner}}
        <div class="hidden" id="winner-data">
          {{if eq .Winner "R"}}R{{else if eq .Winner "Y"}}Y{{else}}draw{{end}}
        </div>
        <p class="winner hidden">
          {{if eq .Winner "R"}}ğŸ”´ Team Rouge a gagnÃ© ! ğŸ¥³
          {{else if eq .Winner "Y"}}ğŸŸ¡ Team Jaune a gagnÃ© ! ğŸ¥³
          {{else}}Match nul ğŸ˜”{{end}}
        </p>
      {{end}}


      <!-- Grille du jeu -->
      <div class="board-wrapper">
        <table class="board" role="grid" aria-label="Grille Power 4">
          <tbody>
            {{range $i := seq 5 0}} <!-- lignes de bas en haut -->
              <tr>
                {{range $index, $cell := index $.Grid $i}} <!-- chaque cellule -->
                  <td>
                    <div class="cell">
                      {{if eq $cell "R"}}
                        <div class="token red" aria-label="Jeton rouge"></div>
                      {{else if eq $cell "Y"}}
                        <div class="token yellow" aria-label="Jeton jaune"></div>
                      {{else}}
                        <div class="token empty" aria-label="Case vide"></div>
                      {{end}}
                    </div>
                  </td>
                {{end}}
              </tr>
            {{end}}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal des rÃ©sultats -->
  <!-- Modal des rÃ©sultats -->
<div id="resultModal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modalTitle" class="modal-title">ğŸ‰ FÃ©licitations !</h2>
        <p id="modalMessage" class="modal-message"></p>
        <div class="modal-actions">
            <button class="modal-btn primary" onclick="resetGame()">
                ğŸ”„ Nouvelle Partie
            </button>
            <button class="modal-btn secondary" onclick="goToHome()">
                ğŸ  Retour Ã  l'Accueil
            </button>
        </div>
    </div>
</div>

  <!-- Footer -->
  <footer class="footer">
    <p>â­ Power 4 Web â€” CrÃ©Ã© avec passion â­</p>
  </footer>

  <script>
    // Fonctions pour gÃ©rer le thÃ¨me
    function initTheme() {
        const theme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", theme);
        updateThemeButton(theme);
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeButton(newTheme);
    }

    function updateThemeButton(theme) {
        const themeBtn = document.querySelector(".theme-btn");
        if (themeBtn) {
            themeBtn.innerHTML = theme === "light" ? "ğŸŒ™" : "â˜€ï¸";
        }
    }

    // ğŸ¯ JOUER UN COUP AVEC AJAX
    async function playMove(column) {
        console.log("Jouer dans la colonne:", column);

        try {
            const response = await fetch("/api/play", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: "column=" + column,
            });

            if (response.ok) {
                // Recharger la page pour voir les changements
                window.location.reload();
            } else {
                const errorText = await response.text();
                console.error("Erreur serveur:", errorText);
                alert("Impossible de jouer: " + errorText);
            }
        } catch (error) {
            console.error("Erreur rÃ©seau:", error);
            // Fallback: rechargement classique
            window.location.href = "/play?column=" + column;
        }
    }

    // ğŸ¯ MODAL DES RÃ‰SULTATS
    function showGameResult(winner) {
        const modal = document.getElementById("resultModal");
        const modalMessage = document.getElementById("modalMessage");
        const modalTitle = document.getElementById("modalTitle");

        if (winner === "R") {
            modalTitle.textContent = "ğŸ‰ FÃ©licitations !";
            modalMessage.innerHTML = "ğŸ”´ <strong>Team Rouge</strong> a gagnÃ© la partie !";
        } else if (winner === "Y") {
            modalTitle.textContent = "ğŸ‰ FÃ©licitations !";
            modalMessage.innerHTML = "ğŸŸ¡ <strong>Team Jaune</strong> a gagnÃ© la partie !";
        } else {
            modalTitle.textContent = "ğŸ¤ Match Nul";
            modalMessage.innerHTML = "La grille est pleine !<br>Aucun gagnant cette fois-ci.";
        }

        modal.classList.add("active");
        document.body.style.overflow = "hidden";
    }

    function hideGameResult() {
        const modal = document.getElementById("resultModal");
        modal.classList.remove("active");
        document.body.style.overflow = "auto";
    }

    function resetGame() {
        // CORRECTION : Ne pas cacher le modal, la redirection le fera
        document.querySelector('form[action="/reset"]').submit();
    }

    function goToHome() {
    // Appeler le handler de nettoyage avant de rediriger
    fetch('/clean', {
        method: 'POST'
    }).then(() => {
        window.location.href = "/";
    }).catch(() => {
        window.location.href = "/";
    });
}

    // ğŸ¯ INITIALISATION
    document.addEventListener("DOMContentLoaded", function () {
        initTheme();

        // Remplacer les formulaires par des appels AJAX
        document.querySelectorAll(".playform").forEach((form) => {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                const column = this.querySelector('input[name="column"]').value;
                playMove(column);
            });
        });

        // Afficher le modal si il y a un gagnant au chargement initial
        const winnerData = document.getElementById("winner-data");
        if (winnerData) {
            const winner = winnerData.textContent.trim();
            if (winner === "R" || winner === "Y" || winner === "draw") {
                setTimeout(() => showGameResult(winner), 500);
            }
        }

        // Ã‰vÃ©nements du modal
        const modal = document.getElementById("resultModal");
        if (modal) {
            modal.addEventListener("click", function (e) {
                if (e.target === modal) {
                    hideGameResult();
                }
            });
        }

        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
                hideGameResult();
            }
        });

        // Ã‰vÃ©nement du bouton theme
        const themeBtn = document.querySelector(".theme-btn");
        if (themeBtn) {
            themeBtn.addEventListener("click", toggleTheme);
        }
    });
</script>

  <style>
    /* Styles supplÃ©mentaires pour le footer et autres Ã©lÃ©ments */
    .footer {
      text-align: center;
      padding: 2rem;
      background: var(--bg-card);
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      margin-top: 2rem;
    }

    .debug-info {
      margin: 1rem 0;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
    }

    .debug-info summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .debug-info p {
      margin: 0.5rem 0;
      font-size: 0.9em;
      color: var(--text-secondary);
    }

    /* AmÃ©lioration de l'accessibilitÃ© */
    @media (prefers-reduced-motion: reduce) {
      .token:not(.empty) {
        animation: none;
      }
      
      .card:hover {
        transform: none;
      }
      
      button:hover, .col-btn:hover {
        transform: none;
      }
    }

    /* Styles d'impression */
    @media print {
      .theme-switcher,
      .playbar,
      form[action="/reset"] {
        display: none;
      }
      
      .card {
        box-shadow: none;
        border: 2px solid #000;
      }
    }
  </style>
</body>
</html>